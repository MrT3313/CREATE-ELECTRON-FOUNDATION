# ==================================================================================================
# SUMMARY
# ==================================================================================================
# This file defines the End-to-End (E2E) testing workflow for the CLI project.
#
# Purpose:
#   To test the complete functionality of the CLI tool. This is done by running the CLI to
#   scaffold new projects with various feature combinations and then validating the
#   integrity and structure of these scaffolded projects.
#
# Triggers:
#   - Pull Requests: Activates on pull requests to the 'main' branch that modify files within
#     the 'cli/**' directory or this workflow file itself.
#   - Manual Dispatch: Can be triggered manually from the GitHub Actions UI via 'workflow_dispatch'.
#
# Job: e2e-test
#   The workflow consists of a single job, 'e2e-test', which runs on 'ubuntu-latest'.
#   It leverages a matrix strategy to execute tests across 8 different configurations,
#   covering combinations of routers, styling options, databases, and ORMs.
#
# Key Steps for each matrix combination:
#   1. Setup Environment: Checks out the repository, sets up the Node.js environment based on
#      the '.nvmrc' file, and installs dependencies for the CLI.
#   2. Build CLI: Compiles the CLI tool by running the 'npm run build' command.
#   3. Scaffold Test Project: Executes the compiled CLI with flags corresponding to the
#      current matrix configuration (e.g., router, styles). This generates a new project
#      in a temporary directory.
#   4. Validate Scaffolded Project: A series of checks are performed to ensure the
#      scaffolded project has the correct file structure based on the selected options.
#      Key files verified include:
#        - TanStack Router: 'src/routes/__root.tsx', 'src/routes/index.tsx'
#        - React Router:    'src/App.tsx', 'src/routes/index.tsx'
#        - Tailwind CSS:    'tailwind.config.js'
#        - Drizzle ORM:     'drizzle.config.ts', 'src/api/useResource.ts'
#
# This E2E setup ensures that the CLI can reliably generate valid project structures for
# all supported feature combinations.
# ==================================================================================================

name: E2E Tests # displayed on the GitHub Actions UI.

# 1. üëÄ CONFIGURE: workflow triggers
on:
  # 1.
  # Allows manual triggering of the workflow from the GitHub Actions UI.
  workflow_dispatch:

  # 2. Pull Requests | branches: [main]
  pull_request:
    branches:
      - main # ONLY run on PRs targeting the main branch
    # ONLY trigger if files change in CLI code.
    paths:
      - 'cli/**' # matches the directory of your CLI source code.
      - '.github/workflows/e2e.yml' # Also run if the E2E workflow file itself changes.

  # 3. Scheduled CRON
  # schedule:
  #   - cron: '0 0 * * *' # Example: Runs every day at midnight UTC.

# 2. üëÄ Defines the jobs for this workflow.
jobs:
  e2e-test:
    name: E2E Test - ${{ matrix.config.name }}
    # Specifies the type of runner for this job, using a matrix variable.
    runs-on: ${{ matrix.config.os }}

    ###########################################################################
    # ‚≠êÔ∏è
    # CONFIGURE: workflow strategy for running the job multiple times with different configurations.
    ###########################################################################
    strategy:
      # If true: GitHub cancels all in-progress jobs in the matrix if any job fails.
      # if false: allows all jobs to complete.
      fail-fast: true

      # CONFIGURE: matrix of run configurations.
      matrix:
        # Defines the specific CLI feature combinations to test.
        config:
          # 0. DEFAULT
          - name: 'Tanstack Router, Tailwind, SQLite, Drizzle'
            os: ubuntu-latest
            router: 'tanstack-router'
            styles: 'tailwind'
            db: 'sqlite'
            orm: 'drizzle'

          # 1. Tanstack Router
          - name: 'Tanstack Router, Tailwind'
            os: ubuntu-latest
            router: 'tanstack-router'
            styles: 'tailwind'
            db: 'false'
            orm: 'false'
          - name: 'Tanstack Router, No Styles'
            os: ubuntu-latest
            router: 'tanstack-router'
            styles: 'false'
            db: 'false'
            orm: 'false'
          - name: 'Tanstack Router, No Styles, SQLite, Drizzle'
            os: ubuntu-latest
            router: 'tanstack-router'
            styles: 'false'
            db: 'sqlite'
            orm: 'drizzle'

          # 2. React Router
          - name: 'React Router, Tailwind'
            os: ubuntu-latest
            router: 'react-router'
            styles: 'tailwind'
            db: 'false'
            orm: 'false'
          - name: 'React Router, No Styles'
            os: ubuntu-latest
            router: 'react-router'
            styles: 'false'
            db: 'false'
            orm: 'false'
          - name: 'React Router, Tailwind, SQLite, Drizzle'
            os: ubuntu-latest
            router: 'react-router'
            styles: 'tailwind'
            db: 'sqlite'
            orm: 'drizzle'
          - name: 'React Router, No Styles, SQLite, Drizzle'
            os: ubuntu-latest
            router: 'react-router'
            styles: 'false'
            db: 'sqlite'
            orm: 'drizzle'

    ###########################################################################
    # ‚≠êÔ∏è
    # CONFIGURE: individual job steps to execute for each matrix combination.
    ###########################################################################
    steps:
      # 1. Check out the repository code.
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Read Node.js version from .nvmrc file
      - name: Read .nvmrc
        id: nvm
        run: echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT

      # 3. Setup the environment using the local composite action (./github/actions/setup/action.yml).
      - name: Setup Environment
        uses: ./.github/actions/setup # Path to your local composite action.
        with:
          # Input: Specify the Node.js version for the setup action, read from .nvmrc
          node-version: ${{ steps.nvm.outputs.NODE_VERSION }}

      # 4. Build the CLI.
      # Run the "build" script from your root package.json.
      # job will target the cli/dist/index.js file later.
      - name: Build CLI
        run: npm run build

      #########################################################
      # ‚≠êÔ∏è‚≠êÔ∏è
      # Step 5: Scaffold a test project using the CLI.
      #########################################################
      - name: Scaffold Test Project (using ${{ matrix.config.name }})
        run: |
          set -x

          # Create a temporary directory for the scaffolded project.
          mkdir temp-scaffolded-project

          # Construct the project name for uniqueness.
          project_name="test-proj-${{ matrix.config.router }}"
          if [[ "${{ matrix.config.styles }}" != "false" ]]; then
            project_name+="-${{ matrix.config.styles }}"
          fi
          if [[ "${{ matrix.config.db }}" != "false" ]]; then
            project_name+="-db"
          fi
          if [[ "${{ matrix.config.orm }}" != "false" ]]; then
            project_name+="-orm"
          fi

          echo "PROJECT_NAME=$project_name" >> $GITHUB_ENV

          # Construct arguments, only adding them if they are not 'false'.
          args=()
          args+=("--router=${{ matrix.config.router }}")
          if [[ "${{ matrix.config.styles }}" != "false" ]]; then
            args+=("--styles=${{ matrix.config.styles }}")
          fi
          if [[ "${{ matrix.config.db }}" != "false" ]]; then
            args+=("--database=${{ matrix.config.db }}")
          fi
          if [[ "${{ matrix.config.orm }}" != "false" ]]; then
            args+=("--orm=${{ matrix.config.orm }}")
          fi
          args+=("--ci")
          args+=("--ide=false")
          args+=("--install_packages=false")
          args+=("--initialize_git=false")

          # Execute the CLI to scaffold a new project.
          node cli/dist/index.js "./temp-scaffolded-project/$project_name" "${args[@]}"

      #########################################################
      # ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
      # Step 6+: Validate the scaffolded project.
      # These are placeholder commands. You need to implement actual validation steps based on your CLI's output for each configuration.
      #########################################################
      - name: Verify Project Structure
        run: |
          # Debug: List all files in the generated project directory
          # ls -laR "temp-scaffolded-project/$PROJECT_NAME"

          echo "Verifying project structure for ${{ matrix.config.name }}..."
          echo "TODO..."

          # need to investigate best way to test
          #   - file level: take a snapshot of the "example" project made in the /TEST/test.sh 
          #   - code level: ?? is the resource.tsx using the .db. or the .api.
